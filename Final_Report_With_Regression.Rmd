---
title: "NYC Taxi Riders’ Tipping Behavior Analysis"
author: "Bharat Aluri"
date: "12/17/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Summary

Tips given to Taxi Drivers form a substantial part of their income. They also serve as a loose metric of service quality that can be useful to Taxi companies. In this report, we analyze factors that affect tip ratio and train models to predict tips based on features.
In the case of New York City’s taxi drivers, the most important factors affecting the tips are geographical factors such as the location of the pickup and the dropoff and also trip factors such as trip distance, trip durations and speed. It can also be said that in more affluent parts of the city and during peak hours, a higher percentage tip will be paid to any taxi driver. Hopefully with this information, taxi drivers can better plan their routines for the day in order to increase their own earnings.

Honor Pledge: On our honor, we pledge that we are the sole authors of this paper and   we   have   accurately   cited   all   help   and   references   used   in   its   completion.

# 1. Problem Description

## 1.1 Situation

### 1.1.A Tasking and Literature

Almost half a million taxi trips are made daily in the city that never sleeps, producing a plethora of information that can prove useful for both the passengers and drivers. We choose to understand what features (besides the quality of the  driver) actually factors into the tip received by a cab driver and also into whether the trip is tipped. We also look how different factors affect different tipping variables. We choose to use NYC Green Taxi data[[1](http://www.nyc.gov/html/tlc/html/about/trip_record_data.shtml)] for the month of Sep 2015 for this project. 

In 2013, the TLC (Taxi Limousine Commission), under then mayor Bloomberg, laid out a new program introducing a new taxi system painted 'apple green' on their exteriors. They are the second class citizens in the world of NYC taxis in that they cannot compete with the yellow taxis within the protected 'yellow zone' (below E 96th street and W 110th street). They are only allowed to pick up passengers outside of this “yellow zone”. Green taxis serve New York city by going to places the yellow taxis drivers prefer not to go.

The following paper will outline the analysis utilizing the Evidence Informed Systems Engineering methodology to help inform NYC Cab Drivers outlining: goals, metrics, hypotheses, approach, analysis, evidence and recommendations [2].

A particular study looks at the percent of people that use the preset tip pecents for the trips [[3](http://dfkoz.tumblr.com/post/106719206826/analysis-of-nyc-taxi-tip-data-44-of-passengers)]. This study shows that 44% of the passengers hit the 20% button for the tip. 

The following study[[4](http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0179193)] also dives into the relationship between tipping rates of a trip and the weather, sunlight in particular and  found a small but statistically significant positive relationship between sunlight and tipping. This particular article[[5](http://www.nytimes.com/2013/01/03/nyregion/as-taxi-fares-rise-riders-tips-dont-keep-pace.html)] indicates that the Riders' tips fail to keep the pace as the fares increase.

These two studies[[6](https://cseweb.ucsd.edu/classes/wi17/cse258-a/reports/a075.pdf)] [[7](https://cseweb.ucsd.edu/~jmcauley/cse190/reports/sp15/050.pdf)] are closely related to our project and uses the same data and variables for their studies to study about the factors that affect the tips for the rides. Finally, this study[[8](https://blogs.msdn.microsoft.com/microsoftrservertigerteam/2017/01/17/predicting-nyc-taxi-tips-using-microsoftml/)] does a comparision between different classification methods to predict if a trip is tipped or not.

```{r, echo = FALSE,  warning=FALSE, message=FALSE}
## Loading the libraries

library(tidyverse)
library(stringr)
library(lubridate)
library(corrplot)
library(geojson)
library(geojsonio)
library(leaflet)
library(leaflet.extras)
library(gmodels)
library(randomForest)
library(caret)
library(pROC)
library(sp)

```

```{r, echo = FALSE,  warning=FALSE, message=FALSE}
## Downloading the data to working directory
#URL_G <- "https://s3.amazonaws.com/nyc-tlc/trip+data/green_tripdata_2017-04.csv"

datadictionary_G <-"http://www.nyc.gov/html/tlc/downloads/pdf/data_dictionary_trip_records_green.pdf"

#download.file(URL_G, destfile = basename(URL_G))

#download.file(datadictionary_G,destfile = basename(datadictionary_G)) #Data Dictionary for the Green Taxi Data.

Green <- read_csv("green_tripdata_2015-09.csv")

```

```{r, echo = FALSE,  warning=FALSE, message=FALSE}
## Data Cleaning 

## Modifying variables to factors
green_taxi <- Green
green_taxi <- green_taxi %>% 
  select(-c(Ehail_fee)) %>% 
  mutate(VendorID= factor(VendorID),
         RateCodeID= factor(RateCodeID),
         Store_and_fwd_flag = factor(Store_and_fwd_flag),
         Payment_type = factor(Payment_type),
         Trip_type= factor(Trip_type))

## Cleaning the dirty data
green_taxi <- green_taxi %>% 
  mutate(Fare_amount= abs(Fare_amount),
         Extra = abs(Extra),
         MTA_tax = abs(MTA_tax),
         Tip_amount = abs(Tip_amount),
         Tolls_amount= abs(Tolls_amount),
         improvement_surcharge = abs(improvement_surcharge),
         Total_amount = abs(Total_amount),
         Duration=as.numeric(as.duration(lpep_pickup_datetime %--% Lpep_dropoff_datetime),"minutes"),
         Speed=(Trip_distance/Duration) *60
         ) 

green_taxi <- green_taxi %>% 
  filter(Duration >= 0.5, Duration <= 60,
         Trip_distance > 0, Trip_distance <=50,
         Pickup_latitude !=0,Pickup_longitude !=0,
         Dropoff_latitude !=0, Dropoff_longitude !=0,
         !is.na(Trip_type),
         RateCodeID != "99",
         Fare_amount >= 2.5,
         Payment_type == 1
         )

green_taxi <- green_taxi %>% 
  select(-c(MTA_tax,improvement_surcharge,Total_amount,Extra, Payment_type))
```

```{r, echo = FALSE,  warning=FALSE, message=FALSE}
## Feature Engineering

## Creating Borough variable out of latitutes and longitudes
# Loading the NYC geojson polygon file
nyc<-geojson_read('borough_boundries_shoreline.geojson',what='sp')
Boroughs = c('Manhattan', 'Bronx', 'Brooklyn', 'Queens', 'Staten Island') #BoroughCode Mapping

nyc2<-nyc
nyc2@data[,-c(2)]<-NULL #only keep the borough code, throw away the others

PickupPts<-SpatialPoints(cbind(green_taxi$Pickup_longitude,green_taxi$Pickup_latitude))

PickupPts@proj4string <- nyc@proj4string
pickupBoroughCodes<-PickupPts %over% nyc2
rm(PickupPts)
green_taxi$boroughCode_p <- pickupBoroughCodes$BoroCode
rm(pickupBoroughCodes)

DropoffPts<-SpatialPoints(cbind(green_taxi$Dropoff_longitude,green_taxi$Dropoff_latitude))
DropoffPts@proj4string <- nyc@proj4string
dropoffBoroughCodes<-DropoffPts %over% nyc2
rm(DropoffPts)
green_taxi$boroughCode_d <- dropoffBoroughCodes$BoroCode
rm(dropoffBoroughCodes)

## Extracting the hour and the day of the week of the pickup.
green_taxi$wday  <- wday(green_taxi$lpep_pickup_datetime, abbr = TRUE, label= TRUE)
green_taxi$hour  <- hour(green_taxi$lpep_pickup_datetime)

## Calculating the Tip Percent of the Fare amount
green_taxi$TipPercent  <- (green_taxi$Tip_amount/green_taxi$Fare_amount) * 100.0

# Creating new variable "Tipped" to take on 1 if tipped, 0 if not.
green_taxi$Tipped <- ifelse(green_taxi$Tip_amount==0,0,1)
```

```{r, echo = FALSE,  warning=FALSE, message=FALSE}
##Final Cleaning

Boroughs = c('Manhattan', 'Bronx', 'Brooklyn', 'Queens', 'Staten Island') #BoroughCode Mapping

green_taxi <- green_taxi %>% 
  filter(Speed<100,
         TipPercent<50,
         !is.na(boroughCode_d),
         !is.na(boroughCode_p)) %>% 
  mutate(Tipped= factor(Tipped),
         boroughCode_p = factor(boroughCode_p, labels = Boroughs),
         boroughCode_d = factor(boroughCode_d, labels = Boroughs))
```

### 1.1.B Visualizing the data

We use leaflet package to plot the visualization below. We look the pickup and dropoff locations for the trips for random sample of 8000. This should give us a fair idea of which place the green taxis are ridden to or ridden from.
```{r, echo = FALSE,  warning=FALSE, message=FALSE}
set.seed(1234)
foo <- sample_n(green_taxi, 8e3)

leaflet(data = foo) %>% addProviderTiles("Esri.NatGeoWorldMap") %>%
  addCircleMarkers(~ Pickup_longitude, ~Pickup_latitude, radius = 1,
                   color = "blue", fillOpacity = 0.3)
```

* This shows us that the trips originate from everywhere except manhattan. We will address the reasons for that in the data section. Apart from that we see that the dropoff ocations are widely spread compared to the pickup locations.
The map gives us an idea what some of the our distributions could look like. Let’s start with plotting the target features Tip amount and Tip percent.

```{r, echo = FALSE,  warning=FALSE, message=FALSE}

ggplot(green_taxi, aes(TipPercent))+
  geom_histogram(color = "black",bins = 50)+
  scale_x_continuous(breaks = seq(0,50,5))+
  ylab("Number of Trips")+
  ggtitle("Fig. 2 - Histogram for Tip Percent")

```

* Fig.2 is a histogram of trip across all trips with Tip Percent less than 50. The data has a long tail to its right so we restrict our analysis to trips with tip percents less than 50%. We see that majority of the tip lie between 20% and 25% if no tip trips are excluded. The mean tip percentage is 19% whereas the median tip percent is 21.5%.

```{r, echo = FALSE,  warning=FALSE, message=FALSE}
set.seed(1234)
foo <- sample_n(green_taxi, 8e4)

foo %>%
  filter(Tipped == 1) %>% 
  ggplot(aes(Fare_amount,TipPercent))+
  geom_point(alpha = 0.05)+
  labs(x= "Fare Amount", y = "Tip Percentage")+
  ggtitle("Fig. 3 - Fare Amount vs Tip Percentage")

```

* Fig.3 is a plot of Fare amount (Tip excluded) and the Tip Percentage for all the trips.
The horizontal lines in the graph correspond to the preset tip percentages (20, 25 and 30) that a passenger sees when they swipe their credit card. The asymptotic curves correspond to common tip values (such as USD10 or USD20).


```{r, echo = FALSE,  warning=FALSE, message=FALSE}
by_Duration<-green_taxi %>%
  filter(TipPercent<50) %>% 
  group_by(Duration=floor(Duration)) %>% 
  summarise(Speed = mean(Speed),TipPercent=mean(TipPercent),dist=mean(Trip_distance),count=n())


ggplot(by_Duration, aes(x=(Duration), y=TipPercent)) +
  geom_point(aes(color=count),size=2,shape=1) +
  scale_x_continuous(name='Duration in Minutes',breaks=seq(0,60,by=5))+geom_smooth(se=F) +
  ylab('Tip Percentage')+
  ggtitle('Fig. 4 - The Green Taxi Tip Percentage by Duration')
```


The following observations can be made from fig.4:

1. We see that the higher tip percents are payed for trips with lower durations and it decreases with increase in duration.
2. Most of the trip have durations less than 15 minutes. This might be because people prefer taxis for shorter rides and prefer other means of transport for longer rides.
3. It is also interesting to see that since trips with lower duration time also have lower fares, even if people pay a dollar or two more the Tip Percent is likely to go on the higher side. And riders with longer trip need to cash out more money to achieve higher tip percent.


```{r, echo = FALSE,  warning=FALSE, message=FALSE}

by_wdayNhour<-green_taxi %>%
  group_by(wday,hour) %>%
  summarise(Speed=mean(Speed),Duration=mean(Duration),
            dist=mean(Trip_distance),TipPercent=mean(TipPercent),count=n()) 


ggplot(filter(by_wdayNhour), aes(x=wday, y=as.factor(hour),fill=TipPercent)) +
  geom_tile() +
  scale_fill_gradientn(colors=c('black','dark red','red','orange','yellow','white')) +
  scale_x_discrete(name='week day')+
  ggtitle('Fig. 5 - The Green Taxi Tip Percent in a Weekday vs Hour heat map') +
  ylab('hour') +
  labs(fill="Avg Tip Percent")

```

The heatmap for Tip Percentages by hour of the day and day of the week says:

1. The Tip percent are higher during the evenings on weekdays compared to the weekends. The time during which drivers get paid more tip in term of percent of fare amount is 5pm - 12am.
2. We see that the Tip percent after midnight on weekends is higher compared to the weekdays. This might be because people go home late in the weekends when they leave the late night parties or whatever.
3. The worst tip percent is during early morning between 5-8am and mostly during the weekends. 


```{r, echo = FALSE,  warning=FALSE, message=FALSE}
by_speed<-green_taxi %>%
  filter(Speed<50,TipPercent<50) %>% 
  group_by(Speed=floor(2*Speed)/2) %>% 
  summarise(Duration=mean(Duration),TipPercent=mean(TipPercent),dist=mean(Trip_distance),count=n())


ggplot(by_speed, aes(x=(Speed), y=TipPercent)) +
  geom_point(aes(color=count),size=2,shape=1) +
  scale_x_continuous(name='speed (mph)',breaks=seq(0,50,by=5))+geom_smooth(se=F) +
  ylab('tip percentage')+
  ggtitle('Fig.6 - The Green Taxi Tip Percent by Speed')



```

Fig. 6 is a plot of Tip Percentage to Speed. We also look at the number of trips having those average speeds. We also find-
1. It is interesting to see that higher tip percentages are related to average speeds between 10-15mph.
2. We can see that most of the trips have an average speed of again 10-15mph. This can be due to the fact that most of the trips are within the city and in the busiest areas which have speed restrictions and comparitively heavy traffic.


```{r, echo = FALSE,  warning=FALSE, message=FALSE}

by_pickupNdropoff<-green_taxi %>%
  filter(boroughCode_p!="Staten Island",boroughCode_d!="Staten Island") %>% 
  group_by(boroughCode_p,boroughCode_d) %>%
  summarise(Speed=mean(Speed),Duration=mean(Duration),
            dist=mean(Trip_distance),TipPercent=mean(TipPercent),count=n()) 


ggplot(filter(by_pickupNdropoff), aes(x=boroughCode_p, y=boroughCode_d,fill=TipPercent)) +
  geom_tile() +
  scale_fill_gradientn(colors=c('black','dark red','red','orange','yellow','white')) +
  scale_x_discrete(name='Pickup Borough')+
  ggtitle('Fig. 7 - The Green Taxi Tip Percent in Bouroughs heat map') +
  ylab('Dropoff Borough') +
  labs(fill="Avg Tip Percent")

```

Here we look at the mean average tip percent by the bouroughs. We remove the trips for "Staten Island" because of the small number of trips made to and fro the borough. The following observations can be made from the plot - 

1. It is intersting to see that the taxi drivers are payed the lowest Tip Percent when  a trip is made within Bronx. And also comparitively the riders who get down at Bronx pay the lowest Tip Percent.
2. People who travel to or from Queens seem to pay more tip percent in general compared to all the other boroughs. And specifically people who ride from manhattan pay the highest tip percent. Brooklyn might be the best place to get higher tip percents.
3.Even though the tip percents from riders who get down in brooklyn aren't great. People who travel withing Brooklyn tend to pay the highest tip percent.
4. It will be intersting to research more about who these people might be or thier occupations might be. Having this information would help taxi drivers get the right customer.

### 1.1.C Correlation Plot

```{r, echo = FALSE,  warning=FALSE, message=FALSE}
mycorr <- cor(green_taxi[,c(10,11,12,13,14,16,17,21,22)])
corrplot(mycorr, order = "hclust")
```

After engineering new features and before starting the modelling, we visualise the relations between our numeric parameters using a correlation matrix. We could hence change all our features to numeric to create a correlation plot but, that wouldn't make sense. 

We find:

1. Fare amount and trip distance has significant correlation with tip amount which we are interested in and followed by duration and tip percent. This signifies that with increase in trip distance and fare amount the tip amout increases. So it is interesteing to see that longer trips are associated with higher trip amount.

2. It is interesting to see that the speed and the number of passengers have little to no correlation with tip amount. One reason for lower correlation between number of passengers and tip amount might be the mix of data. The data seems o be dominated with trips with one or two passengers. It will be interesting to see how the correlation turns out to be if the mix of trip with number of passengers is even.

We will keep in mind that Trip distance, fare amount and duration are highly correlated while considering variables for our models.

## 1.2 Goal

While tips to taxi drivers are usually interpreted as a gesture of gratitude for service, we analyze what other factors can have an impact on tips. For example, do Taxi rides starting or ending in richer parts of the city result in better tips?
Our Main goal is to analyse the factors that affect the tips (Tip Percentage) and use these factors to construct models to predict tips. This would help the cab drivers and the taxi companies in knowing their high tip paying customers.

## 1.3 Metrics

Our goal focuses on the tip and we have a variable Tip Amount in our data. But, that alone would not be helpful in learning about the riders' tipping behavior. So, we create a new variable Tip Percent, which is defined as,

$$ \text{Tip Ratio =}  \frac{Tip Amount}{Fare Amount} $$
Where Fare Amount indicates Fare excluding the tips, taxes and tolls.

## 1.4 Hypothesis

Based on the literature review and the data analysis, We would like to prove if the dropoff location and the fare amount are statistically significant in predicting the Tip Percent.
 
In other words, the change in tip percentages is different in different boroughs with change in fare amount.

# 2. Approach

## 2.1 Data

We use the Green Taxi trip data for the month of September 2015 for NYC, which has around 1.5 Million rows. The data is obtained from [NYC Taxi and Limousine Commission](http://www.nyc.gov/html/tlc/html/about/trip_record_data.shtml). To look at the data dictionary for the data, [click here](http://www.nyc.gov/html/tlc/downloads/pdf/data_dictionary_trip_records_green.pdf). There are few things that needs to be noted about the data, the data for year 2015 which we use has the dropoff/pickup_lat/long whereas, the trips data for year 2017 has pickup location id and dropoff location id.

### 2.1.A Missing Data

There are 4 missing values for the "trip_type" variable and 6 observations have "99" for RateCodeID which generally indicates missing values. Other than that, the data has no missing values.

### 2.1.B Data Cleaning

Apart from the missing values as stated above, a few sources of dirtiness in the data are as follows - 

- Unrealistic durations (We extract duration from pickup and dropoff time.)
- Negative fares or zero trip distance
- Wrong GPS coordinates (Zero lat/long)
- Other

For the negative fare amounts, we substitute them with their absolute values since, which might be due to untrained human input error, GPS instrument error, etc.. We extract duration in minutes for the trip from the pickup and dropoff times. We also create a speed variable using duration and trip_distance.

**Data Filtering**

And for filtering the data, we consider the following steps:

1. We ignore the trips with duration of less than a half a minute or greater than 1 hrs. (To ignore trips with that took longer than 3 hrs and also trips that were timed accidently or any other reason. Taxi hire for duration that short are unrealistic anyway.)
2. We remove trips with zero distances or greater than 50 miles. (We restrict ourselves to short distance trips)
3. We ignore trips with pickup/drop_lat/long fo zero values. (This would mean missing lat/long values.)
4. Remove the observations with NA's(or 99) for RateCodeID and Trip_type.
5. Remove fare amounts less than USD 2.5 (Minimum fare).
6. **We finally restrict ourselves to trips that has credit card as the mode of payment because, the tips data is recorded for just credit card tips and the data for cash tips are not included in the dataset.** This can be proved by looking at the sum of the tips for trip with cash as mode of payment vs credit card. The sum of tips for about 800K trips with cash as mode of payment is USD 163 whereas, the sum of tips for 700K trips with credit card as mode of payment is around USD 2 Million.

**Column Selection**

We also remove the following redundant columns:

1. improvement_surcharge, MTA_tax, Extra (These variables have almost same values for most of the trips and would just increase noise.)
2. Total_amount (We already have the Fare_amount and having this variable is unneccesary.)
3. Payment_type

Doing all this brings down the number of observations by more than half. We now have data for around 600K trips.

### 2.1.C Feature Engineering

In this section we build new features from the existing data such as the target variable itself and also new potential predictors for the target variable. 

We extract the borough of the pickups and dropoffs using a geojson polygon file of New York City. We restrict the boroughs to one the following five:
1. Manhattan
2. Bronx
3. Brooklyn
4. Queens
5. Manhattan

The geojson file can be obtained form this link [here](https://github.com/arelenglish/borough_boundries).

We can extract the neighborhoods for the pickups and dropoff too but, that would have a total number of around 300 and getting computational resources to use that variable becomes difficult. So we limit ourselves to the boroughs.

We also extract the hour of the day and the day of the week for the pickups. These variable might lead us to some useful insights on tipping habits of riders. We create a "Tip_percent" variable which gives us the tip in terms of percentage of fare amount.

Finally, we limit

1. Speed variable in the data to 100 (average speed greater than 100 is unrealistic)
2. TipPercent to 100% (It is rare when someone tips higher than the fare amount)
3. Remove the observations which do not fall into either of the 5 bouroughs.

There should be less bias in the data as it was collected electronically and human wasn't a part of data collection. But, it should be noted that there might be more unrealistic recorded data which might be due to some error. We've done our best to eliminate bias in the data.

## 2.2 Analysis

### 2.2.A Test vs Train Overlap

We create a test and a training data set out of the original data. Test dataset will be 1/6th of the original dataset. This test data will be used later on in the analysis to calculate the PMSE for the models. We look at the overlap for a sample test dataset.

```{r, echo = FALSE,  warning=FALSE, message=FALSE}
set.seed(12)

j <- nrow(green_taxi)

sept15 <- green_taxi %>% 
  filter(mday(lpep_pickup_datetime)==15)
k <- nrow(sept15)

taxi_rand <- green_taxi[order(runif(j)), ]
taxi_train <- taxi_rand[1:((5*j)/6), ]
taxi_test  <- taxi_rand[(((5*j)/6)+1):j, ]

sept15_rand <- sept15[order(runif(k)), ]
sept15_train <- sept15_rand[1:((5*k)/6), ]
sept15_test  <- sept15_rand[(((5*k)/6)+1):k, ]

taxi_train$dset <- "train"
taxi_test$dset <- "test"

combine <- rbind(taxi_test,taxi_train)

```

In order to make sure that we are really training on features that are relevant to our test data set we will now briefly compare the temporal and spatial properties of the train and test data. This is another consistency check. Here are two relavent comparision plots.

```{r, echo = FALSE,  warning=FALSE, message=FALSE}
foo <- combine %>%
  mutate(date = date(lpep_pickup_datetime)) %>% 
  group_by(date, dset) %>%
  filter(month(date)==9) %>% 
  count()
           
foo %>%
  ggplot(aes(date, n, color = dset, group = dset)) +
  geom_line(size = 1.5) +
  labs(x = "", y = "Kilo trips per Day")
```

```{r, echo = FALSE,  warning=FALSE, message=FALSE}
pick_good <- combine 
pick_good <- sample_n(pick_good, 5e3)

pick_good %>%
  ggplot(aes(Pickup_longitude, Pickup_latitude, color = dset)) +
  geom_point(size=.5, alpha = 0.5) +
  coord_cartesian() +
  facet_wrap(~ dset) +
  #guides(color = guide_legend(override.aes = list(alpha = 1, size = 4))) +
  theme(legend.position = "none")
```

We find that our train and test data sets do indeed cover the same time range and geographical area.

### 2.2.B Models
We sought to use linear regression methodology to fit a model on our hypothesis. From initial visualizations the day of the fare amount and the pickup and dropoff locations seem to have an affect on Tip Percent. The first linear model we fit focused on how the pickup and dropoff locations with the quantitative variable of interest such as fare amount and passenger count affect the Tip Percent. We don't consider using trip distance or duration as one of our predictors due to high correlation with our predictor variables. We don't have a preference for our base case. So, we proceed with the default. 

We started with a first order linear model for our hypothesis.

```{r, echo= FALSE,  warning=FALSE, message=FALSE}
lmtip1 <- lm(TipPercent~boroughCode_d+boroughCode_p+Fare_amount+Passenger_count,
             data= taxi_train)
```

**TipPercent~boroughCode_d+boroughCode_p+Fare_amount+Passenger_count**

TipPercent: Tip in term of Percentage of Fare amount
boroughcode_d: Dropoff bourough for the trip
boroughcode_p: Pickup borough for the trip
Fare_amount: Fare for the trip excluding tips, taxes and tolls
Passenger_count: Number of passengers on the trip

We see that all the terms are statisticaly significant from Manhattan except for the borough Staten Island in predicting the TipPercent. The less number of trips to and from Staten Island might have been the reason for this insignificance.

We went through the process of model assessment, automated variable selection through stepwise regression and model comparision with another model that includes all the interaction terms:

**TipPercent~(boroughCode_d+boroughCode_p+Fare_amount+Passenger_count)^2**

```{r, echo= FALSE,  warning=FALSE, message=FALSE}
lmtip2 <- lm(TipPercent~(boroughCode_d+boroughCode_p+Fare_amount+Passenger_count)^2,
             data = taxi_train)
lmtip2.step <- step(lmtip2, trace = FALSE)
```
We find that both the models, the first order model and second order model with interaction terms have a significant p-values for the F-statistic. However, we face some problems with the boroughs while fitting our models. The number of trips to and from Staten Island are very low and so few of the interction terms turned out to be NA's. But, we choose to not include Staten Island when we talk about aur models. Our model shows that there is significant difference in the *TipPercent* for the trips taken to and from Manhattan and other boroughs. Even thought the interaction terms between *boroughcode_p/d* and *Fare_amount* have a significant estimates for all boroughs other than Staten Island the values of the estimates are on the lower side when compared to the interaction terms between *boroughcode_p* and *boroughcode_d*. If this is the case with *boroughcodes_p/d* and *Fare_amount*, the interaction terms between *Passenger_count* and *boroughcodes_p* are only significant different from that of Manhattan for Bronx and Brooklyn. Estimates are alson on the lower side when compared to the interactions between *boroughcode_p* and *boroughcode_d*.

> LM1: **TipPercent ~ boroughCode_d+boroughCode_p+Fare_amount+Passenger_count**

> LM2: **TipPercent ~ (boroughCode_d+boroughCode_p+Fare_amount+Passenger_count)^2**

The model utility test illustrated statistical significance of both models. Next, we conducted automated variable selecion method of stepwise regressionto reduce the complexity of linear model 2. The new model resulted in all the interactions except for interactions between *boroughcode_d* and *Passenger_count*.

LM2 (After Step): *TipPercent~(boroughCode_d+boroughCode_p+Fare_amount+Passenger_count)^2*

Next in table, we compared the models linear model 1 (main effects) and linear model 2 (pst step regression with interaction terms).

```{r, include = FALSE,  warning=FALSE, message=FALSE}
#Partial F-test
anova(lmtip1,lmtip2.step)

#Adjusted R^2
summary(lmtip1)$adj.r.squared
summary(lmtip2.step)$adj.r.squared

#AIC
AIC(lmtip1)
AIC(lmtip2.step)
```

|    **Model**    |**Adj R^2**|  **AIC**  |
|:---------------:|:---------:|:---------:|
|LM1              |0.0480     |4226076    |
|LM2(After Step)  |0.0572     |4220653    |

For criterion based assessments, we compare the models with Adjuster R^2 and AIC. Model 2 seems to be a better choice in terms of goodness of fit balanced with model complexity.

Next we conducted partial F-test to compare two models. The test supported model 2. the test revealed that the addition of interaction terms to model provides statistically significant information, with a p-value of 2.2e-16.

Finally, we compared the models via the train/test method. We separated the data into a train and test set. The train set encompassed 5/6 of the entire data; test set encompassed the remaining 1/6 of the data. The sets were checked to ensure they were random and representative. Linear models 1 and 2 were built on the train sets, and evaluated on the test sets. Twenty iterations were executed, with the mean of the predicted mean square errors (PMSE) recorded to compare performance  of the two models.

The plot below illustrates the PMSE for each model during iteration. The table summarises the mean and median PMSE for each model.

```{r, echo = FALSE,  warning=FALSE, message=FALSE}
source("~/Box Sync/Fall17/SYS-6021/R Code/TestSet.R")

pmse1.result <- NULL;
pmse2.result <- NULL;

set.seed(12345)

for (i in c(1:20)){
  test.size <- 1/6
  taxi.data <- test.set(green_taxi, test.size)
  lmtip1.train <- lm(TipPercent~boroughCode_d+boroughCode_p+Fare_amount+Passenger_count, data = taxi.data$train)
  lmtip2.train <- lm(TipPercent~(boroughCode_d+boroughCode_p+Fare_amount+Passenger_count)^2, data = taxi.data$train)
  
  lmtip1.pred <- predict(lmtip1.train, newdata = taxi.data$test)
  lmtip2.pred <- predict(lmtip2.train, newdata = taxi.data$test)
  
  pmse.lm1 <- mse(lmtip1.pred, taxi.data$test$TipPercent)
  pmse.lm2 <- mse(lmtip2.pred,taxi.data$test$TipPercent)
  
  pmse1.result <- c(pmse1.result,pmse.lm1)
  pmse2.result <- c(pmse2.result,pmse.lm2)
}

plot(pmse1.result,type='b',col='blue',xlab= "Index", ylab= "PMSE")
lines(pmse2.result, type = 'b',col ='red')
title(main = 'Model Comparison Based on PMSE')
```

| **Line**|    **Model**    |**Mean PMSE**|  **Median PMSE**  |
|:-------:|:---------------:|:-----------:|:-----------------:|
|Blue     |LM1              |92.725       |92.758             |
|Red      |LM2(After Step)  |91.902       |91.942             |

Model 2 has a lower PMSE by small margin, suggesting a better fit to the data and suggesting that model 2 has better predictive accuracy.

In conclusion, AIC, the partial F-test, Adj. R^2 and the PMSE suggests that model 2 as a better linear model.we sought to capitalize on the analytical granularity that the complex model offers. The insights on interactions will help us provide more targeted recommendations to the stake holders.

# 3. Evidence

After conducting the model assessments and comparisions for our hypothesis, we move to the evaluations of the model. The following model is being evaluated under diagnostics:

**Hypothesis**: Step of *"TipPercent~(boroughCode_d+boroughCode_p+Fare_amount+Passenger_count)^2"*

## 3.1 Diagnostics for Hypothesis

Below are the diagnostic plots for our hypothesis

```{r, echo = FALSE,  warning=FALSE, message=FALSE}
plot(lmtip2.step)
```

Reviewing the Residual vs. Fitted plot and the Scale-Location plot, the error seems to be random and probably due to high concentration of fitted values in a small range. This might be due to the lower prediction power of the model.
The Normal Q-Q plot reveals the tails are divergent, especially on the right hand side. This illustrates the limits of the model in low and high value points. The Residual vs. Leverage plot reveals three more possible influential points. After investigating these two events, it was decided to remove them within the data as they were just normal trips but with high TipPercent, removing which would probably increase the model performance.

Linear model 2 is the model we apply to our hypothesis. The model is statistically significant with a p-value of 2.2e-16, as articulated by the model utility test. The model is articulated in the appendix of the report. The complete summary of the model can be found in the appendix section.

Overall, we find the model for our hypothesis is not particularly good at prediction but, important insights can be drawn from the model. It is also important to note that it proves our hypothesis true. The model illustrates statistical significance between the pickup and dropoff boroughs. It also shows the significance of fare amount and passenger count in predicting the tip percentage, eventhough the accuracy of the model is pretty low.

Going back to the model we see that the trip that originates from any borough but end at Bronx has comparitively lower tipping rates when compared to our base case manhattan. This statement can be supported by the estimated and the p-values for the interaction terms in our 2nd linear model with interaction terms. It can also be said that all the other trip have caomparitively higher Tip Percent when compare to trips that originate from and end at Manhattan. However, the difference in the tipping Percent are different for different pairs of boroughs. Only excet to this apart from Bronx are the trips that originate from Bronx and end at Brooklyn. This has lower tip percentage too.

The Fare_amount is found to be statistically significant in precicting the tip percent. The models hows a decrease in tip percent with increase in fare amount  when the pickup and dropoff location is Queens when compared to Manhattan. However, when compared to Manhattan, the tip percents decreases with increase in fare amount if the dropoff locations are Bronx and Brooklyn but, tip percent increases if people are pick up from these locations. However, the interaction terms with the pickup/dropoff boroughs shows little to no difference in the tip percentage even though that difference is statistically significant. In reality his cannot be translated into actionable recommendation.

The Passenger count is found to be statistically significant as well. When compared to Manhattan the tip percents increase with increase in number of passengers if the trip originates from Bronx and decreses if a trip originates in Brooklyn. However, the passenger count variable doesn't satisfy the normal condition and majority of the trip have 1 or 2 passengers, so this can't be relied upon in making recommendations or statements about the affect of number of passengers in predicting tip percentage.

## 3.2 Comparing to Random Forest

To compare the linear models prediction accuracy to other sophisticated models, we train a random forest model and calculate the MSE. Random Forests solve the proble of variance which decison trees and bagging suffers. Random forest does this by decorrelating the trees by choosing the best variable to split the node from a new set of variables everytime. We now train a regression random forest model.

```{r, echo = FALSE,  warning=FALSE, message=FALSE}
sept15_test <- sept15_test[,-c(2,3,6,7,8,9,13,23)]
sept15_train <- sept15_train[,-c(2,3,6,7,8,9,13,23)]

random.forest.model <- randomForest(sept15_train[,-c(15)], sept15_train$TipPercent, ntree = 50)

varImpPlot(random.forest.model)
```
```{r, include= FALSE,  warning=FALSE, message=FALSE}
print(random.forest.model)
```
The above plot shows the variables that are considered important in predicting the Tip Percent variable. It shows that the Trip distance, duration and speed are the most important variables in the data set in predicting the target variable. It also shows that hour of the day and the fare amount play an important role as well. This doesn't explain the increase or decrease of tip percentage, rather it gives the variables that are related to change in tip percentage. When we use 50 trees due to limited computational power, we see that the MSE is 111.5, this can be due to the less trees used or might be because the random forest complicates a simple model.

# 4. Recommendations/Conclusions

Although the model was statistically significant in predicting the tip percents, the MSE for the model is high and hence, the model cannot be usedfor prediction of tipping percent. We can further decrease our RMSE if we are presented with information of the rider and driver for each trip. Tipping habits of riders and quality of service of drivers matter towards tipping at least as much as pickup locations, etc. However, the model gives some useful insights on what factors into the tipping behavior of the NYC taxi riders' such as the pickup and dropoff locations, duration of trip, average speed and trip distance. The models shows that having pickup locations at a particular borough at a particular time can lead to an increased tiping percentage. This information is useful to the can drivers and the taxi companies if the goal is to increase the tip percent of the trip.

We conclude that viewing tips as solely a measure of service quality can be misleading. A large number of factors such as location, trip distance, trip duration and fare have a significant effect on tip. There are also some temporal effects on tip, such as the time of day and day of week.

## 4.1 Recommendations on Follow of Analysis

Even though, our model didn't turn out to be of  much help, a further research in this direction can lead to more useful insights. A few of them are as follows.

1. We can use extend our analysis by introducing external data such as the weather data which can further talk about how the changes in weather changes the riders tipping behavior. This data can be exctracted from National Weather Service Forecast Office [website](http://w2.weather.gov/climate/xmacis.php?wfo=okx). It would be interesting to look if rainy days and snowy days changes how the rider tips.

2. Due to computational limitations, we didn't have a chance to use the neighborhood data of pickups and dropoffs. There were around 300 neighborhood categories for the data we have and it is just not plausible to use a variable with 300 categories. So, instead we just used the boroughs. I believe using neighborhoods would be a great way to how the tipping behavior changes across neighborhoods or see which areas gets the most tips. The shapefile for the neighborhood can be found at [Zillow](https://www.zillow.com/howto/api/neighborhood-boundaries.htm).

3. Instead of looking at whether a ride results in a tip or not, it would be more interesting to look at how these variables affect the tip in terms of percentage of fare amount. We could use regression models instead of classification models to achieve the same. It would be more helpful and meaningful to regular taxi driver to know which places or time gets more tip than knowing plainly whether a trip gets you a tip or not.

4. We can compare the tipping behaviors of the riders for the yellow taxis and the green taxis. We can even introduce Uber and Lyft data to differentiate between the services.

5. Finally, due to computational limitations, we had to limit our data to a month for exploratory data analysis and to a day for modelling and prediction. It would be more accurate if we can look at the data for an year or more, where the season or months might be a potential predictor for answering the question.


# 5. References

[1] NYC Taxi Commission and Limousine Website. Available at: http://www.nyc.gov/html/tlc/html/about/trip_record_data.shtml

[2] Project   1   template,"   Class   template   in   SYS   4021,   2017.

[3] Analysis of NYC Taxi Tip Data: 44% of Passengers Hit the 20% Button. Available at: http://dfkoz.tumblr.com/post/106719206826/analysis-of-nyc-taxi-tip-data-44-of-passengers

[4] Taxicab Tipping and Sunlight. Available at: http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0179193

[5] FLEGENHEIMER, M. As Taxi Fares Increase, Riders’ Tips Fail to Keep Pace.(2013) Available at: http://www.nytimes.com/2013/01/03/nyregion/as-taxi-fares-rise-riders-tips-dont-keep-pace.html

[6] Gupta,S. and Nagda R. NYC Taxi Tip-Rate Prediction. Available at: https://cseweb.ucsd.edu/classes/wi17/cse258-a/reports/a075.pdf

[7]Jain, S. and See, A. Predicting Taxi Tip-Rates in NYC Available at: https://cseweb.ucsd.edu/~jmcauley/cse190/reports/sp15/050.pdf

[8]Chandrasekharan, R. Predicting NYC Taxi Tips using MicrosoftML. Available at: https://blogs.msdn.microsoft.com/microsoftrservertigerteam/2017/01/17/predicting-nyc-taxi-tips-using-microsoftml/


## 5.A Appendix A

Summary of our choosen linear model with interaction terms. It is also the stepped versionof the model which resulted in high accuracy.
```{r}
summary(lmtip2.step)
```

This is the main effects model which we compared our best model to 
```{r}
summary(lmtip1)
```

And finally this is the random forest model summary
```{r}
print(random.forest.model)
```

